<!DOCTYPE html>
<html lang="en" class="w-full h-full">

<head>
    <meta charset="UTF-8" />
    <title>Vue 3 Weather App</title>

    <!-- Tailwind CSS v2 minified -->
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">

    <!-- Vue 3 production -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        html,
        body,
        #app {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>

</head>

<body class="w-full h-full">

    <div id="app"></div>

    <script type="module">


        // -------------------------------
        // Translations class
        // -------------------------------
        import { Translations } from "./translations.js"
        // -------------------------------
        // Axios instance
        // -------------------------------
        const api = axios.create({ baseURL: "https://api.met.no/weatherapi" });

        // -------------------------------
        // Settings Component
        // -------------------------------
        import { SettingComponent } from "./components/settingComponent.js"


        // -------------------------------
        // WeatherCard Component
        // -------------------------------
        const WeatherCard = {
            props: { contentBlock: Object, day: Object, orientation: String },
            template: /*HTML*/ `
                <div v-if="orientation == 'landscape'" 
                     class="rounded-2xl p-4 shadow-2xl text-center transform hover:scale-105 transition-transform duration-300 flex-shrink-0"
                     :style="{ 
                         backgroundColor: contentBlock.properties.cardBackgroundColor, 
                         color: contentBlock.properties.textColor, 
                         width: '20vmin',
                         height: '30vmin'
                     }">

                    <h2 class="font-semibold mb-2" style="font-size: 3vmin; min-height: 6vmin">
                        {{ displayWeekDay }}
                    </h2>
                    <img
                        :src="weatherIconSrc"
                        :alt="day.symbolCode"
                        class="mx-auto mb-4"
                        style="width: 12vmin; height: 12vmin;"
                    />
                    <p class="font-bold" style="font-size: 4.5vmin; line-height: 1">{{ displayTemperature }}</p>
                </div>

                <div v-if="orientation == 'portrait'"
                    class="rounded-2xl p-4 shadow-2xl transform hover:scale-105 transition-transform duration-300 flex items-center justify-between flex-shrink-0 mb-4"
                    :style="{ 
                        backgroundColor: contentBlock.properties.cardBackgroundColor, 
                        color: contentBlock.properties.textColor, 
                        width: '90%',
                        height: '15vmin'
                    }">
                    
                    <!-- Left: Day -->
                    <h2 class="font-semibold" style="font-size: 4vmin; width: 30%">{{ displayWeekDay }}</h2>
                    
                    <!-- Center: Icon -->
                    <img
                        :src="weatherIconSrc"
                        :alt="day.symbolCode"
                        style="width: 10vmin; height: 10vmin;"
                    />

                    <!-- Right: Temperature -->
                    <div class="text-right" style="width: 30%">
                        <p class="font-bold" style="font-size: 5vmin">{{ displayTemperature }}</p>
                    </div>
                </div>
            `,
            computed: {
                displayTemperature() {
                    if (this.contentBlock.properties.showCelcius) {
                        return `${this.day.temperature}°C`
                    }
                    return `${Math.round(this.day.temperature * 9 / 5 + 32)}°F`
                },
                displayWeekDay() {
                    if (this.orientation == "landscape")
                        return this.capitalizeFirst(new Date(this.day.date).toLocaleDateString(this.contentBlock.properties.language.split('-')[0], { weekday: 'short' }))
                    return this.capitalizeFirst(new Date(this.day.date).toLocaleDateString(this.contentBlock.properties.language.split('-')[0], { weekday: 'long' }))
                },
                weatherIconSrc() {
                    if (!this.day.condition) return ''
                    if (this.day.condition == "clear")
                        return `./png/clearsky_day.png`
                    return `./png/${this.day.condition}.png`
                }

            },
            methods: {
                capitalizeFirst(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1).replace('.', '');
                }
            }
        };

        // -------------------------------
        // Root App
        // -------------------------------
        const App = {
            components: { SettingComponent, WeatherCard },
            template: /*HTML*/ `
                <div class="w-full h-full flex flex-col"
                    :style="{ 
                        backgroundColor: contentBlock.properties.appBackgroundColor, 
                        color: contentBlock.properties.textColor 
                    }">

                    <!-- Today Weather Panel -->
                    <div v-if="todayWeather && orientation === 'landscape'"
                        class="flex justify-between items-center p-4 rounded-xl flex-shrink-0"
                        style="height: 50vh">
                        
                        <!-- Left: Day & Date -->
                        <div class="flex flex-col items-start justify-center space-y-2 ml-8" style="height: 100%">
                            <h2 class="font-bold" style="font-size: 5vmin">{{ todayWeekDay }}</h2>
                            <h2 class="font-bold" style="font-size: 6vmin">{{ contentBlock.properties.locationShortName }}</h2>
                            <p class="opacity-70" style="font-size: 3vmin">{{ todayWeather.date }}</p>
                        </div>

                        <!-- Center: Temperature & Icon -->
                        <div class="flex items-center justify-center space-x-6" style="height: 100%">
                            <p class="font-extrabold" style="font-size: 16vmin">{{ todayTemperature }}</p>
                            <img :src="todayIcon" :alt="todayWeather.symbolCode" style="width: 25vmin; height: 25vmin;" />
                        </div>

                        <!-- Right: Additional Info -->
                        <div class="flex flex-col items-end justify-center space-y-2 text-right mr-8" style="height: 100%">
                            <p class="opacity-80" style="font-size: 3vmin">{{contentBlock.properties.texts.precipitation}}: {{ todayWeather.precipitation || 0 }}%</p>
                            <p class="opacity-80" style="font-size: 3vmin">{{contentBlock.properties.texts.humidity}}: {{ todayWeather.humidity || 0 }}%</p>
                            <p class="opacity-80" style="font-size: 3vmin">{{contentBlock.properties.texts.wind}}: {{ todayWeather.wind }} km/h</p>
                        </div>
                    </div>

                    <!-- Portrait layout for today weather -->
                    <div v-if="todayWeather && orientation === 'portrait'"
                        class="flex flex-col items-center justify-center p-4 rounded-xl flex-shrink-0"
                        style="height: 50vh">
                        
                        <!-- Location and Date -->
                        <div class="text-center mb-4">
                                                    <!-- Day Name -->
                            <h2 class="font-bold mb-4" style="font-size: 5vmin">{{ todayWeekDay }} {{ todayWeather.date }}</h2>
                            <p class="opacity-70 mb-4" style="font-size: 5vmin"></p>
                            <h2 class="font-bold" style="font-size: 6vmin">{{ contentBlock.properties.locationShortName }}</h2>
                        </div>

                        <!-- Temperature and Icon Row -->
                        <div class="flex items-center justify-center space-x-6 mb-4">
                            <p class="font-extrabold" style="font-size: 14vmin">{{ todayTemperature }}</p>
                            <img :src="todayIcon" :alt="todayWeather.symbolCode" style="width: 20vmin; height: 20vmin;" />
                        </div>


                        
                        <!-- Weather Details -->
                        <div class="flex justify-center space-x-8">
                            <p class="opacity-80" style="font-size: 3vmin">{{contentBlock.properties.texts.precipitation}}: {{ todayWeather.precipitation || 0 }}%</p>
                            <p class="opacity-80" style="font-size: 3vmin">{{contentBlock.properties.texts.humidity}}: {{ todayWeather.humidity || 0 }}%</p>
                            <p class="opacity-80" style="font-size: 3vmin">{{contentBlock.properties.texts.wind}}: {{ todayWeather.wind }} km/h</p>
                        </div>
                    </div>

                    <!-- Forecast Cards Container -->
                    <div v-if="weather" 
                        class="flex-1 flex items-center justify-center p-4"
                        :class="orientation === 'portrait' ? 'flex-col' : 'flex-row'">
                        
                        <div class="flex gap-4"
                            :class="orientation === 'portrait' ? 'flex-col items-center w-full' : 'flex-row justify-center w-full'">
                            <WeatherCard
                                v-for="day in (weather || []).slice(1, contentBlock.properties.showDays)"
                                :key="day.date"
                                :day="day"
                                :contentBlock="contentBlock"
                                :orientation="orientation"
                            />
                        </div>
                    </div>

                    <!-- Loading / Error -->
                    <div v-if="loading || error" class="w-full h-full flex items-center justify-center">
                        <p v-if="loading" class="text-center text-lg" style="font-size: 4vmin">
                            Loading weather...
                        </p>
                        <p v-if="error" class="text-center text-red-300 font-semibold" style="font-size: 4vmin">
                            {{ error }}
                        </p>
                    </div>

                    <!-- Cogwheel -->
                    <div class="absolute top-4 right-4 z-50">
                        <button
                            @click="showSettings = !showSettings"
                            class="p-2 bg-white bg-opacity-20 backdrop-blur-md rounded-full hover:bg-opacity-40 transition flex items-center justify-center"
                            style="font-size: 3vmin; width: 8vmin; height: 8vmin;"
                        >
                            ⚙️
                        </button>
                    </div>

                    <!-- Settings Panel -->
                    <div
                        v-if="showSettings"
                        class="fixed top-0 right-0 h-full w-80 bg-black bg-opacity-70 backdrop-blur-md p-6 shadow-xl z-40 overflow-auto"
                    >
                        <SettingComponent
                            :contentBlock="contentBlock"
                            :Translations="Translations"
                            @update:contentBlock="contentBlock = $event"
                            @save="onSettingsSave"
                            @cancel="showSettings = false"
                        />
                    </div>

                </div>
            `,
            data() {
                return {
                    loading: false,
                    error: null,
                    weather: null,
                    showSettings: false,
                    contentBlock: { properties: {} },
                    orientation: null
                };
            },
            computed: {
                todayWeather() {
                    return this.weather && this.weather.length ? this.weather[0] : null
                },
                todayWeekDay() {
                    if (!this.todayWeather) return ''
                    const locale = this.contentBlock.properties.language.split('-')[0]
                    return this.capitalizeFirst(
                        new Date(this.todayWeather.date).toLocaleDateString(locale, { weekday: 'long' })
                    )
                },
                todayTemperature() {
                    if (!this.todayWeather) return ''
                    return this.contentBlock.properties.showCelcius
                        ? `${this.todayWeather.temperature}°C`
                        : `${Math.round(this.todayWeather.temperature * 9 / 5 + 32)}°F`
                },
                todayIcon() {
                    if (!this.todayWeather || !this.todayWeather.symbolCode) return './png/cloudy.png'
                    return `./png/${this.todayWeather.symbolCode}.png`
                }
            },
            methods: {
                async fetchWeather() {
                    this.loading = true;
                    this.error = null;
                    this.weather = null;

                    const lat = this.contentBlock.properties.lat;
                    const lon = this.contentBlock.properties.lon;
                    const numberOfDays = this.contentBlock.properties.showDays;

                    try {
                        const res = await api.get("/locationforecast/2.0/compact", { params: { lat, lon } });
                        const timeseries = res.data.properties.timeseries;

                        const daysMap = {};
                        const result = [];

                        for (const ts of timeseries) {
                            const date = ts.time.split("T")[0];
                            if (!daysMap[date]) {
                                daysMap[date] = true;
                                result.push({
                                    date,
                                    temperature: ts.data.instant.details.air_temperature,
                                    wind: ts.data.instant.details.wind_speed,
                                    condition: ts.data.next_1_hours?.summary.symbol_code || "clear"
                                });
                                if (result.length >= numberOfDays) break;
                            }
                        }

                        this.weather = result;
                    } catch (e) {
                        this.error = "Failed to load weather data";
                    } finally {
                        this.loading = false;
                    }
                },
                async resolveLocation(query) {
                    if (!query) return null;
                    try {
                        const res = await axios.get("https://nominatim.openstreetmap.org/search", {
                            params: {
                                q: query,
                                format: "json",
                                limit: 1
                            },
                            headers: { "Accept-Language": this.contentBlock.properties.language.split('-')[0] }
                        });
                        if (res.data.length) {
                            const place = res.data[0];

                            this.contentBlock.properties.lat = parseFloat(place.lat);
                            this.contentBlock.properties.lon = parseFloat(place.lon);
                            this.contentBlock.properties.location = place.display_name;
                            this.contentBlock.properties.locationShortName = place.display_name.split(',')[0];

                            return true;
                        }
                    } catch (err) {
                        console.error("Nominatim error:", err);
                    }
                    return false;
                },
                onSettingsSave() {
                    this.handleNewSettings();
                    this.showSettings = false;
                },
                async iframeMessageHandler(e) {
                    if (e && e.data) {
                        if (e.data == '{}') {
                            this.contentBlock = {};
                        }
                        else {
                            console.log('e', e);

                            const contentBlock = JSON.parse(e.data);
                            this.contentBlock = contentBlock;
                            this.handleNewSettings();
                        }
                    }
                },
                async handleNewSettings() {
                    this.contentBlock.properties.texts = new Translations(this.contentBlock.properties.language).texts
                    const resolved = await this.resolveLocation(this.contentBlock.properties.location);
                    if (!resolved) {
                        this.error = this.contentBlock.properties.texts.PlaceNotFoundError;
                        return;
                    }

                    this.fetchWeather();
                },
                checkOrientation() {
                    if (window.innerHeight > window.innerWidth) {
                        this.orientation = 'portrait';
                    }
                    else {
                        this.orientation = 'landscape';
                    }
                },
                capitalizeFirst(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1).replace('.', '')
                }
            },
            mounted() {
                this.contentBlock = {
                    properties: {
                        appBackgroundColor: "#2b1055",
                        cardBackgroundColor: "#3b1c6e",
                        textColor: "#ffffff",
                        language: "en-EN",
                        location: "Oslo, Norway",
                        locationShortName: "Oslo",
                        lat: 59.9114,
                        lon: 10.7579,
                        showDays: 4,
                        showCelcius: true,
                        texts: new Translations("en-EN").texts
                    }
                }
                window.addEventListener('message', this.iframeMessageHandler);
                this.checkOrientation();
                window.addEventListener('resize', this.checkOrientation);
                this.fetchWeather();
            },
            beforeUnmount() {
                window.removeEventListener('resize', this.checkOrientation)
                window.removeEventListener('message', this.iframeMessageHandler)
            }
        };

        Vue.createApp(App).mount("#app");
    </script>
</body>

</html>