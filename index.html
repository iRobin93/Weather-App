<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Vue 3 Weather App</title>

    <!-- Tailwind CSS v2 minified -->
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">

    <!-- Vue 3 production -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="min-h-screen">

    <div id="app"></div>

    <script type="module">


        // -------------------------------
        // Translations class
        // -------------------------------
        import { Translations } from "./translations.js"
        // -------------------------------
        // Axios instance
        // -------------------------------
        const api = axios.create({ baseURL: "https://api.met.no/weatherapi" });

        // -------------------------------
        // Settings Component
        // -------------------------------
        import { SettingComponent } from "./components/settingComponent.js"


        // -------------------------------
        // WeatherCard Component
        // -------------------------------
        const WeatherCard = {
            props: { contentBlock: Object, day: Object, orientation: String },
            template: `
                        <div v-if="orientation == 'landscape'" class="rounded-2xl p-6 shadow-2xl text-center transform hover:scale-105 transition-transform duration-300 flex-shrink-0"
                            :style="{ backgroundColor: contentBlock.properties.cardBackgroundColor, color: contentBlock.properties.textColor, width: '180px' }">

                        <h2 class="text-xl font-semibold">
                        {{ capitalizeFirst(new Date(day.date).toLocaleDateString(contentBlock.properties.language.split('-')[0], { weekday: 'short' })) }}
                        </h2>
                        <p class="text-3xl font-bold">{{ day.temperature }}°C</p>
                        <p class="text-lg">{{ contentBlock.properties.texts.wind }}: {{ day.wind }} m/s</p>
                        <p class="capitalize">{{ day.condition }}</p>
                        </div>
                        

                        <div v-if="orientation == 'portrait'" class="rounded-2xl p-6 shadow-2xl text-center transform hover:scale-105 transition-transform duration-300 flex-shrink-0"
                            :style="{ backgroundColor: contentBlock.properties.cardBackgroundColor, color: contentBlock.properties.textColor, width: '180px' }">

                        <h2 class="text-xl font-semibold">
                        {{ capitalizeFirst(new Date(day.date).toLocaleDateString(contentBlock.properties.language.split('-')[0], { weekday: 'short' })) }}
                        </h2>
                        <p class="text-3xl font-bold">{{ day.temperature }}°C</p>
                        <p class="text-lg">{{ contentBlock.properties.texts.wind }}: {{ day.wind }} m/s</p>
                        <p class="capitalize">{{ day.condition }}</p>
                        </div>


                    `,
            methods: {
                capitalizeFirst(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1).replace('.', '');
                },
            }
        };

        // -------------------------------
        // Root App
        // -------------------------------
        const App = {
            components: { SettingComponent, WeatherCard },
            template: `
                        <div class="min-h-screen flex flex-col items-center justify-center transition-colors duration-300"
                            :style="{ backgroundColor: contentBlock.properties.appBackgroundColor }">

                        <div class="w-full max-w-md p-6 space-y-6">


                            <p v-if="loading" class="text-center text-white text-lg">
                            Loading weather...
                            </p>

                       <div
                            v-if="weather"
                            class="flex gap-4"
                            :class="orientation === 'portrait'
                                ? 'flex-col items-center'
                                : 'flex-row justify-start flex-nowrap'">

                            <WeatherCard
                                v-for="day in (weather || []).slice(0, contentBlock.properties.showDays)"
                                :key="day.date"
                                :day="day"
                                :contentBlock="contentBlock"
                                :orientation="orientation"
                            />
                        </div>



                        <p v-if="error" class="text-center text-red-300 font-semibold">
                        {{ error }}
                        </p>
                    </div>

                    <!-- Cogwheel -->
                    <div class="fixed top-4 right-4 z-50">
                        <button
                        @click="showSettings = !showSettings"
                        class="p-2 bg-white bg-opacity-20 backdrop-blur-md rounded-full hover:bg-opacity-40 transition"
                        >
                        ⚙️
                        </button>
                    </div>

                    <!-- Settings -->
                    <div
                        v-if="showSettings"
                        class="fixed top-0 right-0 h-full w-80 bg-black bg-opacity-70 backdrop-blur-md p-6 shadow-xl z-40 overflow-auto"
                    >
                        <SettingComponent
                        :contentBlock="contentBlock"
                        :Translations="Translations"
                        @update:contentBlock="contentBlock = $event"
                        @save="onSettingsSave"
                        @cancel="showSettings = false"
                        />
                    </div>
                    </div>
                    `
            ,
            data() {
                return {
                    loading: false,
                    error: null,
                    weather: null,
                    showSettings: false,
                    contentBlock: { properties: {} },
                    orientation: null,

                };
            },
            methods: {
                async fetchWeather() {
                    this.loading = true;
                    this.error = null;
                    this.weather = null;




                    const lat = this.contentBlock.properties.lat;
                    const lon = this.contentBlock.properties.lon;
                    const numberOfDays = this.contentBlock.properties.showDays;

                    try {
                        const res = await api.get("/locationforecast/2.0/compact", { params: { lat, lon } });
                        const timeseries = res.data.properties.timeseries;

                        const daysMap = {};
                        const result = [];

                        for (const ts of timeseries) {
                            const date = ts.time.split("T")[0];
                            if (!daysMap[date]) {
                                daysMap[date] = true;
                                result.push({
                                    date,
                                    temperature: ts.data.instant.details.air_temperature,
                                    wind: ts.data.instant.details.wind_speed,
                                    condition: ts.data.next_1_hours?.summary.symbol_code || "clear"
                                });
                                if (result.length >= numberOfDays) break;
                            }
                        }

                        this.weather = result;
                    } catch (e) {
                        this.error = "Failed to load weather data";
                    } finally {
                        this.loading = false;
                    }
                },

                async resolveLocation(query) {
                    if (!query) return null;
                    try {
                        const res = await axios.get("https://nominatim.openstreetmap.org/search", {
                            params: {
                                q: query,
                                format: "json",
                                limit: 1
                            },
                            headers: { "Accept-Language": this.contentBlock.properties.language.split('-')[0] }
                        });
                        if (res.data.length) {
                            const place = res.data[0];

                            this.contentBlock.properties.lat = parseFloat(place.lat);
                            this.contentBlock.properties.lon = parseFloat(place.lon);
                            this.contentBlock.properties.location = place.display_name;
                            this.contentBlock.properties.locationShortName = place.display_name.split(',')[0];

                            return true;
                        }
                    } catch (err) {
                        console.error("Nominatim error:", err);
                    }
                    return false;
                },
                onSettingsSave() {
                    const resolved = this.resolveLocation(this.contentBlock.properties.location);
                    if (!resolved) {
                        this.error = this.contentBlock.properties.texts.PlaceNotFoundError;
                        return;
                    }
                    this.fetchWeather();
                    this.showSettings = false;
                },
                iframeMessageHandler(e) {
                    if (e && e.data) {
                        if (e.data == '{}') {
                            this.contentBlock = {};
                        }
                        else {
                            console.log('e', e);

                            const contentBlock = JSON.parse(e.data);
                            this.contentBlock = contentBlock;

                        }
                    }
                },
                checkOrientation() {
                    if (window.innerHeight > window.innerWidth) {
                        this.orientation = 'portrait';
                    }
                    else {
                        this.orientation = 'landscape';
                    }
                },

            },
            mounted() {
                this.contentBlock = {
                    properties: {
                        appBackgroundColor: "#2b1055",
                        cardBackgroundColor: "#3b1c6e",
                        textColor: "#ffffff",
                        language: "en-EN",
                        location: "Oslo, Norway",
                        locationShortName: "Oslo",

                        lat: 59.9114,
                        lon: 10.7579,
                        showDays: 1,
                        showCelcius: true,
                        texts: new Translations("en-EN").texts
                    }
                }
                window.addEventListener('message', this.iframeMessageHandler);
                this.checkOrientation();
                window.addEventListener('resize', this.checkOrientation);
                this.fetchWeather();
            }
        };

        Vue.createApp(App).mount("#app");
    </script>
</body>

</html>